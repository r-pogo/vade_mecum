# Nmap (gui zenmap)
Nmap uses IP packets to scan networks for hosts, open ports and vulnerabilities.  

## Fazy
`Target Enumeration`: Nmap determines the list of target IP addresses based on user input.  
`Host Discovery`: Nmap determines which hosts are online.  
`Reverse-DNS Resolution`: Nmap uses reverse-DNS resolution to determine the names of hosts.  
`Port Scanning`: Nmap sends probes (various IP packets) and collects the responses which are used to classify ports into different states.  
`Version detection`: Nmap sends additional packets and evaluates responses.  
`OS detection`: Nmap evaluates responses to probes to determine the operating system.  
`Traceroute`: Nmap contains its own traceroute function.  
`Script scanning`: The nmap scripting Engine can be leveraged to expand on Nmap's capabilities.  
`Output`: Outputs results on the screen.

## Usage 

`nmap [Scan Type(s)] [Options] {target specification}`

Default scan type: nmap runs a SYN (stealth scan) scan when no specified type is entered
Other scan types use the properties of TCP/UDP packets and connections.
Stealth scan minimizes the likelihood of detection by the target system or intrusion detection systems

In a SYN scan, Nmap sends only a SYN packet (the first step in the TCP handshake) to the target port.
If the port is open, the target responds with a SYN-ACK. Nmap does not complete the handshake; instead, it sends a RST (Reset) packet to close the connection. This incomplete handshake often avoids logging on the target system, as the connection never fully establishes.

Default options: by default it runs host discovery and scans 1000 TCP ports
Port scanning options enable selection from  to all ports.
Additional options allow for service, version and OS detection.

Target specification: has no default option. Can take list of IP addresses, hostnames and networks.  
Options include input of a list from a name.
Nmap ca also select targets at random.

This command will tell nmap to run a stealth SYN scan your loopback interface for port 22 ssh.
```
nmap -sS -p22 127.0.0.1

Starting Nmap 7.80 ( https://nmap.org ) at 2024-11-21 19:25 CET
Nmap scan report for localhost (127.0.0.1)
Host is up (0.0021s latency).

PORT   STATE  SERVICE
22/tcp closed ssh

Nmap done: 1 IP address (1 host up) scanned in 0.48 seconds
```
___
## Host Enumeration and Network Mapping (Fazy 1-3)
- Determine which hosts are active
- Find hosts running a particular service
- Find unauthorized devices on the network
- Determine the focus of further scans

### List Scan (-sL)
`-sL` performs: 
- Lists all host thet will be scanned
- Performs reverse-DNS resolution on hosts

Is commonly used for enumeration and preparation before deeper analysis:

```
nmap -sL cosTam.com/27 ---> 27 is for the size of the subnet
```
The command above lists all IP addresses in the /27 subnet associated with cosTam.com, along with their DNS names if resolvable. It does not actively scan or probe the targets.

### Ping Scan (-sn)
`-sn` is for hosts discovery and performs:
- finds a list of available hosts
- by default sends an ICMP and TCP packet to determine if a host is up
- Can be combined with `-PS` option to check for other ports

It gets a respons from the host and thus verifying if it is online.

```
nmap -sn 192.168.0.0/27 --dns-servers 192.168.0.5

Output example:

Nmap scan report for 192.168.0.1
Host is up (0.012s latency).
Nmap scan report for printer.local (192.168.0.10)
Host is up (0.021s latency).
Nmap scan report for 192.168.0.15
Host is up (0.045s latency).

```

Explanation:

1. `-sn: Ping Scan (No Port Scanning)`
The -sn option tells Nmap to only discover live hosts in the target range (192.168.0.0/27) without performing any port scanning.
It checks if hosts are up using:  
ICMP Echo Requests (ping).  
TCP SYN requests to port 443.  
Other lightweight probes, depending on the configuration.  
This mode is ideal for determining which devices in the range are online.  


2. `192.168.0.0/27: Target Subnet`
The 192.168.0.0/27 is a CIDR (Classless Inter-Domain Routing) range specifying 32 IP addresses:  
From 192.168.0.0 to 192.168.0.31.  
Nmap will probe each of these IP addresses.  


3. `--dns-servers 192.168.0.5: Custom DNS Server`
This option specifies a custom DNS server (in this case, 192.168.0.5) to resolve hostnames during the scan.  
By default, Nmap uses the system's configured DNS servers. Adding this option overrides that behavior.  
When a live host is detected in the subnet, Nmap queries 192.168.0.5 to attempt reverse DNS resolution (i.e., mapping the IP address to a hostname).
### Scanning specific hosts and subnets

- Subnets can be given in CIDR notation
- A range is entered using a hyphen
- Hostnames ca be used in place of IPs
- Devices can be excluded using `--exclude` option
- `iL` option followed by filename to send a list of hosts to Nmap to scan
- `-iR` option tells Nmap to generate a random list of IP addresses for scanning

### How to defend against Nmap host discovery

Defense against the ping scan:
- Configure a host or network firewall to block ICMP traffic

Nmap also sends TCP packets to port 80 and 443 to see if hosts responds.
To prevent this you need to take the same action on your host:

- Configure firewall to drop TCP packets for port 80 and 443 unless needed.

The issue with using a network firewall to block these port is that they are used for http/https traffic
___

## Port scanning (Faza 4)
- Detect outdated or valuable services
- Detect vulnerable applications
- Detect hosts not found with a ping
- Discover unnecessary services running on devices

### Basics
- default scans 1000 ports.
- `-p` allows to specify port.
- `-F` fat mode runs a default scan but uses the most common 100 ports instead of 1000.
- `-r` not to randomize.
- `--top-ports` example: --top-ports 50 nmap will scan the 50 most commonly open ports.
- `--port-ratio` is followed with a decimal number between 0 and 1 like --top-ports utilizes  
the ports listed in Nmap services and selects ports that have a greater ratio value than the number you entered.  
This ratio is the frequency that nmap researchers found that port open when running scans.

```
nmap -p-1023 192.168.0.5 # with a port range

nmap -p1-1023,[1024-] win2k12-ad # [] only include ports that are registered in Nmap services.

```
### Protecting against port scanning
- Scan your own network with nmap and close unnecessary ports and patch or mitigate vulnerabilities.
- Block scans with network firewalls
- Implement network security tools that can detect scans
___
## Performance and timing 
Timing control options:

`--min- and --max-hostgroup`: controls the number of hosts that are scanned concurrently by Nmap
`--min- and --max- parallelism`: how many probes are launched in parallel
`--min-, --max-, and -inital-rtt-timeout`: control probe timeouts. Higher timeout values men that nmap will wait longer to receive each probe.
`--max-retries`: 
`--host-timeout`:
`--scan-delay and --max-scan-delay`: control the time between each probe sent to an individual host.
`--min- and --max-rate`: controls the number of packets sent per second

Timing templates:
`T0 and T1`: high scan delay, and only send one probe at a time
`T2 and T3`: similar to previous but lower timeout values
`T4 and T5`: faster options
___
## Service Version, Application Version, OS Detection
`-sV`:  This option is used for service version detection. It attempts to determine the version of the services running on open ports.  
Nmap will try to gather as much information as possible about each service to provide details such as software name, version,  
and sometimes even configuration options.

```
nmap -sV -T4 192.168.0.5

Starting Nmap 7.80 ( https://nmap.org ) at 2024-11-22 10:10 PST
Nmap scan report for 192.168.0.5
Host is up (0.00053s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
443/tcp open  ssl/http Apache httpd 2.4.38 ((Debian))
1 service unrecognized despite sending 1 probe
Nmap done: 1 IP address (1 host up) scanned in 5.10 seconds
```

`-O`: operating system detection.
`--osscan-limit`: instruct Nmap to limit OS detection to promising targets only.
`--osscan-guess`: tells namp to aggressively guess operating system of all detected targets in the scan

`nmap -O -T4 192.168.0.0/28`
___
## Sources
- M. Glass, Getting started with nmap 7, https://app.pluralsight.com/


